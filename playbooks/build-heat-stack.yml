---
- hosts: localhost
  gather_facts: no
  vars:
    heat_environment_file: "heat_params.yml"

  tasks:
    - name: Build a Heat stack for the NGINX VM
      register: heat_stack
      os_stack:
        name: "nginx-vm-stack"
        state: present
        template: "heat_stack_vm.yml"
        environment: "{{ heat_environment_file }}"

    - name: Debug the Heat stack outputs
      debug:
        var: heat_stack

    - name: Wait for the VM to become accessible
      wait_for:
        host: "{{ heat_stack.stack.outputs | selectattr('output_key', 'equalto', 'floating_ip') | map(attribute='output_value') | first }}"
        port: 22
        state: started
        timeout: 300

    - name: Add host to the dynamic inventory
      add_host:
        name: "{{ heat_stack.stack.outputs | selectattr('output_key', 'equalto', 'floating_ip') | map(attribute='output_value') | first }}"
        groups: "nginx_vm"
        ansible_ssh_user: "ubuntu"
